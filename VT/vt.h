#pragma once

NTSTATUS VMXON(int i);

#define 	EXIT_REASON_EXCEPTION_NMI   0 
#define 	EXIT_REASON_EXTERNAL_INTERRUPT   1 
#define 	EXIT_REASON_TRIPLE_FAULT   2 
#define 	EXIT_REASON_INIT   3 
#define 	EXIT_REASON_SIPI   4 
#define 	EXIT_REASON_IO_SMI   5 
#define 	EXIT_REASON_OTHER_SMI   6 
#define 	EXIT_REASON_PENDING_VIRT_INTR   7 
#define 	EXIT_REASON_PENDING_VIRT_NMI   8 
#define 	EXIT_REASON_TASK_SWITCH   9 
#define 	EXIT_REASON_CPUID   10 
#define 	EXIT_REASON_GETSEC   11 
#define 	EXIT_REASON_HLT   12 
#define 	EXIT_REASON_INVD   13 
#define 	EXIT_REASON_INVLPG   14 
#define 	EXIT_REASON_RDPMC   15 
#define 	EXIT_REASON_RDTSC   16 
#define 	EXIT_REASON_RSM   17 
#define 	EXIT_REASON_VMCALL   18 
#define 	EXIT_REASON_VMCLEAR   19 
#define 	EXIT_REASON_VMLAUNCH   20 
#define 	EXIT_REASON_VMPTRLD   21 
#define 	EXIT_REASON_VMPTRST   22 
#define 	EXIT_REASON_VMREAD   23 
#define 	EXIT_REASON_VMRESUME   24 
#define 	EXIT_REASON_VMWRITE   25 
#define 	EXIT_REASON_VMXOFF   26 
#define 	EXIT_REASON_VMXON   27 
#define 	EXIT_REASON_CR_ACCESS   28 
#define 	EXIT_REASON_DR_ACCESS   29 
#define 	EXIT_REASON_IO_INSTRUCTION   30 
#define 	EXIT_REASON_MSR_READ   31 
#define 	EXIT_REASON_MSR_WRITE   32 
#define 	EXIT_REASON_INVALID_GUEST_STATE   33 
#define 	EXIT_REASON_MSR_LOADING   34 
#define 	EXIT_REASON_UNDEFINED_1   35 
#define 	EXIT_REASON_MWAIT_INSTRUCTION   36 
#define 	EXIT_REASON_MONITOR_TRAP_FLAG   37 
#define 	EXIT_REASON_UNDEFINED_2   38 
#define 	EXIT_REASON_MONITOR_INSTRUCTION   39 
#define 	EXIT_REASON_PAUSE_INSTRUCTION   40 
#define 	EXIT_REASON_MCE_DURING_VMENTRY   41 
#define 	EXIT_REASON_UNDEFINED_3   42 
#define 	EXIT_REASON_TPR_BELOW_THRESHOLD   43 
#define 	EXIT_REASON_APIC_ACCESS   44 
#define 	EXIT_REASON_EOI_INDUCED   45 
#define 	EXIT_REASON_ACCESS_GDTR_OR_IDTR   46 
#define 	EXIT_REASON_ACCESS_LDTR_OR_TR   47 
#define 	EXIT_REASON_EPT_VIOLATION   48 
#define 	EXIT_REASON_EPT_MISCONFIG   49 
#define 	EXIT_REASON_INVEPT   50 
#define 	EXIT_REASON_RDTSCP   51 
#define 	EXIT_REASON_VMX_PREEMPTION_TIMER_EXPIRED   52 
#define 	EXIT_REASON_INVVPID   53 
#define 	EXIT_REASON_WBINVD   54 
#define 	EXIT_REASON_XSETBV   55 
#define 	EXIT_REASON_APIC_WRITE   56 
#define 	EXIT_REASON_RDRAND   57 
#define 	EXIT_REASON_INVPCID   58 
#define 	EXIT_REASON_VMFUNC   59 
#define 	EXIT_REASON_UNDEFINED_4   60 
#define 	EXIT_REASON_RDSEED   61 
#define 	EXIT_REASON_UNDEFINED_5   62 
#define 	EXIT_REASON_XSAVES   63 
#define 	EXIT_REASON_XRSTORS   64 
#define 	VMX_MAX_GUEST_VMEXIT 



typedef struct Register
{
	ULONGLONG rax;
	ULONGLONG rcx;
	ULONGLONG rdx;
	ULONGLONG rbx;
	ULONGLONG rbp;
	ULONGLONG rsi;
	ULONGLONG rdi;
	ULONGLONG r8;
	ULONGLONG r9;
	ULONGLONG r10;
	ULONGLONG r11;
	ULONGLONG r12;
	ULONGLONG r13;
	ULONGLONG r14;
	ULONGLONG r15;
	ULONGLONG Number;
	ULONGLONG rip;
	ULONGLONG rsp;
}Register, *PRegister;






ULONG	VIRTUAL_PROCESSOR_ID = 0x00000000;
ULONG	POSTED_INTR_NV = 0x00000002;
ULONG	GUEST_ES_SELECTOR = 0x00000800;
ULONG	GUEST_CS_SELECTOR = 0x00000802;
ULONG	GUEST_SS_SELECTOR = 0x00000804;
ULONG	GUEST_DS_SELECTOR = 0x00000806;
ULONG	GUEST_FS_SELECTOR = 0x00000808;
ULONG	GUEST_GS_SELECTOR = 0x0000080a;
ULONG	GUEST_LDTR_SELECTOR = 0x0000080c;
ULONG	GUEST_TR_SELECTOR = 0x0000080e;
ULONG	GUEST_INTR_STATUS = 0x00000810;
ULONG	HOST_ES_SELECTOR = 0x00000c00;
ULONG	HOST_CS_SELECTOR = 0x00000c02;
ULONG	HOST_SS_SELECTOR = 0x00000c04;
ULONG	HOST_DS_SELECTOR = 0x00000c06;
ULONG	HOST_FS_SELECTOR = 0x00000c08;
ULONG	HOST_GS_SELECTOR = 0x00000c0a;
ULONG	HOST_TR_SELECTOR = 0x00000c0c;
ULONG	IO_BITMAP_A_ADDRESS = 0x00002000;
ULONG	IO_BITMAP_A_HIGH_ADDRESS = 0x00002001;
ULONG	IO_BITMAP_B_ADDRESS = 0x00002002;
ULONG	IO_BITMAP_B_HIGH_ADDRESS = 0x00002003;
ULONG	MSR_BITMAP_address = 0x00002004;
ULONG	MSR_BITMAP_HIGH = 0x00002005;
ULONG	VM_EXIT_MSR_STORE_ADDR = 0x00002006;
ULONG	VM_EXIT_MSR_STORE_ADDR_HIGH = 0x00002007;
ULONG	VM_EXIT_MSR_LOAD_ADDR = 0x00002008;
ULONG	VM_EXIT_MSR_LOAD_ADDR_HIGH = 0x00002009;
ULONG	VM_ENTRY_MSR_LOAD_ADDR = 0x0000200a;
ULONG	VM_ENTRY_MSR_LOAD_ADDR_HIGH = 0x0000200b;
ULONG	TSC_OFFSET = 0x00002010;
ULONG	TSC_OFFSET_HIGH = 0x00002011;
ULONG	virtual_APIC_address = 0x00002012;
ULONG	VIRTUAL_APIC_PAGE_ADDR_HIGH = 0x00002013;
ULONG	APIC_access_address = 0x00002014;
ULONG	APIC_ACCESS_ADDR_HIGH = 0x00002015;
ULONG	POSTED_INTR_DESC_ADDR = 0x00002016;
ULONG	POSTED_INTR_DESC_ADDR_HIGH = 0x00002017;
ULONG   VM_function_control = 0x2018;
ULONG	EPT_POINTER = 0x0000201a;
ULONG	EPT_POINTER_HIGH = 0x0000201b;
ULONG	EOI_EXIT_BITMAP0 = 0x0000201c;
ULONG	EOI_EXIT_BITMAP0_HIGH = 0x0000201d;
ULONG	EOI_EXIT_BITMAP1 = 0x0000201e;
ULONG	EOI_EXIT_BITMAP1_HIGH = 0x0000201f;
ULONG	EOI_EXIT_BITMAP2 = 0x00002020;
ULONG	EOI_EXIT_BITMAP2_HIGH = 0x00002021;
ULONG	EOI_EXIT_BITMAP3 = 0x00002022;
ULONG	EOI_EXIT_BITMAP3_HIGH = 0x00002023;
ULONG	VMREAD_BITMAP = 0x00002026;
ULONG	VMWRITE_BITMAP = 0x00002028;
ULONG	XSS_EXIT_BITMAP = 0x0000202C;
ULONG	XSS_EXIT_BITMAP_HIGH = 0x0000202D;
ULONG	GUEST_PHYSICAL_ADDRESS = 0x00002400;
ULONG	GUEST_PHYSICAL_ADDRESS_HIGH = 0x00002401;
ULONG	VMCS_LINK_POINTER = 0x00002800;
ULONG	VMCS_LINK_POINTER_HIGH = 0x00002801;
ULONG	GUEST_IA32_DEBUGCTL = 0x00002802;
ULONG	GUEST_IA32_DEBUGCTL_HIGH = 0x00002803;
ULONG	GUEST_IA32_PAT = 0x00002804;
ULONG	GUEST_IA32_PAT_HIGH = 0x00002805;
ULONG	GUEST_IA32_EFER = 0x00002806;
ULONG	GUEST_IA32_EFER_HIGH = 0x00002807;
ULONG	GUEST_IA32_PERF_GLOBAL_CTRL = 0x00002808;
ULONG	GUEST_IA32_PERF_GLOBAL_CTRL_HIGH = 0x00002809;
ULONG	GUEST_PDPTR0 = 0x0000280a;
ULONG	GUEST_PDPTR0_HIGH = 0x0000280b;
ULONG	GUEST_PDPTR1 = 0x0000280c;
ULONG	GUEST_PDPTR1_HIGH = 0x0000280d;
ULONG	GUEST_PDPTR2 = 0x0000280e;
ULONG	GUEST_PDPTR2_HIGH = 0x0000280f;
ULONG	GUEST_PDPTR3 = 0x00002810;
ULONG	GUEST_PDPTR3_HIGH = 0x00002811;
ULONG	GUEST_BNDCFGS = 0x00002812;
ULONG	GUEST_BNDCFGS_HIGH = 0x00002813;
ULONG	HOST_IA32_PAT = 0x00002c00;
ULONG	HOST_IA32_PAT_HIGH = 0x00002c01;
ULONG	HOST_IA32_EFER = 0x00002c02;
ULONG	HOST_IA32_EFER_HIGH = 0x00002c03;
ULONG	HOST_IA32_PERF_GLOBAL_CTRL = 0x00002c04;
ULONG	HOST_IA32_PERF_GLOBAL_CTRL_HIGH = 0x00002c05;
ULONG	PIN_BASED_VM_EXEC_CONTROL = 0x00004000;
ULONG	Primary_processor_based_VM_execution_controls = 0x00004002;
ULONG	EXCEPTION_BITMAP = 0x00004004;
ULONG	PAGE_FAULT_ERROR_CODE_MASK = 0x00004006;
ULONG	PAGE_FAULT_ERROR_CODE_MATCH = 0x00004008;
ULONG	CR3_TARGET_COUNT = 0x0000400a;
ULONG	VM_EXIT_CONTROLS = 0x0000400c;
ULONG	VM_EXIT_MSR_STORE_COUNT = 0x0000400e;
ULONG	VM_EXIT_MSR_LOAD_COUNT = 0x00004010;
ULONG	VM_ENTRY_CONTROLS = 0x00004012;
ULONG	VM_ENTRY_MSR_LOAD_COUNT = 0x00004014;
ULONG	VM_ENTRY_INTRRUPTION_INFORMATION_FIELD = 0x00004016;
ULONG	VM_ENTRY_EXCEPTION_ERROR_CODE = 0x00004018;
ULONG	VM_ENTRY_INSTRUCTION_LEN = 0x0000401a;
ULONG	TPR_THRESHOLD = 0x0000401c;
ULONG	Secondary_processor_based_VM_execution_controls = 0x0000401e;
ULONG	PLE_GAP = 0x00004020;
ULONG	PLE_WINDOW = 0x00004022;
ULONG	VM_INSTRUCTION_ERROR = 0x00004400;
ULONG	VM_EXIT_REASON = 0x00004402;
ULONG	VM_EXIT_INTR_INFO = 0x00004404;
ULONG	VM_EXIT_INTR_ERROR_CODE = 0x00004406;
ULONG	IDT_VECTORING_INFO_FIELD = 0x00004408;
ULONG	IDT_VECTORING_ERROR_CODE = 0x0000440a;
ULONG	VM_EXIT_INSTRUCTION_LEN = 0x0000440c;
ULONG	VMX_INSTRUCTION_INFO = 0x0000440e;
ULONG	GUEST_ES_LIMIT = 0x00004800;
ULONG	GUEST_CS_LIMIT = 0x00004802;
ULONG	GUEST_SS_LIMIT = 0x00004804;
ULONG	GUEST_DS_LIMIT = 0x00004806;
ULONG	GUEST_FS_LIMIT = 0x00004808;
ULONG	GUEST_GS_LIMIT = 0x0000480a;
ULONG	GUEST_LDTR_LIMIT = 0x0000480c;
ULONG	GUEST_TR_LIMIT = 0x0000480e;
ULONG	GUEST_GDTR_LIMIT = 0x00004810;
ULONG	GUEST_IDTR_LIMIT = 0x00004812;
ULONG	GUEST_ES_AR_BYTES = 0x00004814;
ULONG	GUEST_CS_AR_BYTES = 0x00004816;
ULONG	GUEST_SS_AR_BYTES = 0x00004818;
ULONG	GUEST_DS_AR_BYTES = 0x0000481a;
ULONG	GUEST_FS_AR_BYTES = 0x0000481c;
ULONG	GUEST_GS_AR_BYTES = 0x0000481e;
ULONG	GUEST_LDTR_AR_BYTES = 0x00004820;
ULONG	GUEST_TR_AR_BYTES = 0x00004822;
ULONG	GUEST_INTERRUPTIBILITY_INFO = 0x00004824;
ULONG	GUEST_ACTIVITY_STATE = 0X00004826;
ULONG	GUEST_SYSENTER_CS = 0x0000482A;
ULONG	VMX_PREEMPTION_TIMER_VALUE = 0x0000482E;
ULONG	HOST_IA32_SYSENTER_CS = 0x00004c00;
ULONG	CR0_GUEST_HOST_MASK = 0x00006000;
ULONG	CR4_GUEST_HOST_MASK = 0x00006002;
ULONG	CR0_READ_SHADOW = 0x00006004;
ULONG	CR4_READ_SHADOW = 0x00006006;
ULONG	CR3_TARGET_VALUE0 = 0x00006008;
ULONG	CR3_TARGET_VALUE1 = 0x0000600a;
ULONG	CR3_TARGET_VALUE2 = 0x0000600c;
ULONG	CR3_TARGET_VALUE3 = 0x0000600e;
ULONG	EXIT_QUALIFICATION = 0x00006400;
ULONG	GUEST_LINEAR_ADDRESS = 0x0000640a;
ULONG	GUEST_CR0 = 0x00006800;
ULONG	GUEST_CR3 = 0x00006802;
ULONG	GUEST_CR4 = 0x00006804;
ULONG	GUEST_ES_BASE = 0x00006806;
ULONG	GUEST_CS_BASE = 0x00006808;
ULONG	GUEST_SS_BASE = 0x0000680a;
ULONG	GUEST_DS_BASE = 0x0000680c;
ULONG	GUEST_FS_BASE = 0x0000680e;
ULONG	GUEST_GS_BASE = 0x00006810;
ULONG	GUEST_LDTR_BASE = 0x00006812;
ULONG	GUEST_TR_BASE = 0x00006814;
ULONG	GUEST_GDTR_BASE = 0x00006816;
ULONG	GUEST_IDTR_BASE = 0x00006818;
ULONG	GUEST_DR7 = 0x0000681a;
ULONG	GUEST_RSP = 0x0000681c;
ULONG	GUEST_RIP = 0x0000681e;
ULONG	GUEST_RFLAGS = 0x00006820;
ULONG	GUEST_PENDING_DBG_EXCEPTIONS = 0x00006822;
ULONG	GUEST_SYSENTER_ESP = 0x00006824;
ULONG	GUEST_SYSENTER_EIP = 0x00006826;
ULONG	HOST_CR0 = 0x00006c00;
ULONG	HOST_CR3 = 0x00006c02;
ULONG	HOST_CR4 = 0x00006c04;
ULONG	HOST_FS_BASE = 0x00006c06;
ULONG	HOST_GS_BASE = 0x00006c08;
ULONG	HOST_TR_BASE = 0x00006c0a;
ULONG	HOST_GDTR_BASE = 0x00006c0c;
ULONG	HOST_IDTR_BASE = 0x00006c0e;
ULONG	HOST_IA32_SYSENTER_ESP = 0x00006c10;
ULONG	HOST_IA32_SYSENTER_EIP = 0x00006c12;
ULONG	HOST_RSP = 0x00006c14;
ULONG	HOST_RIP = 0x00006c16;

ULONG MSR_IA32_VMX_BASIC = 0x480;
ULONG MSR_IA32_FEATURE_CONTROL = 0x03a;
ULONG MSR_IA32_VMX_PINBASED_CTLS = 0x481;
ULONG MSR_IA32_VMX_PROCBASED_CTLS = 0x482;
ULONG MSR_IA32_VMX_PROCBASED_CTLS2 = 0x48b;
ULONG MSR_IA32_VMX_EXIT_CTLS = 0x483;
ULONG MSR_IA32_VMX_ENTRY_CTLS = 0x484;

#define MSR_IA32_SYSENTER_CS 0x174
#define MSR_IA32_SYSENTER_ESP  0x175
#define MSR_IA32_SYSENTER_EIP  0x176
#define MSR_IA32_DEBUGCTL  0x1d9
#define MSR_EFER  0xc0000080
ULONG IA32_VNX_VMFUNC = 0X491;
/*ULONG MSR_IA32_VMX_TRUE_PINBASED_CTLS = 0x48d;
ULONG MSR_IA32_VMX_TRUE_PROCBASED_CTLS = 0x48e;
ULONG MSR_IA32_VMX_TRUE_EXIT_CTLS = 0x48f;
ULONG MSR_IA32_VMX_TRUE_ENTRY_CTLS = 0x490;*/    //true寄存器 在驱动中已经判断了

/* x86-64 MSR */


ULONG MSR_STAR = 0xc0000081;
ULONG MSR_LSTAR = 0xc0000082;
ULONG MSR_CSTAR = 0xc0000083;
ULONG MSR_SYSCALL_MASK = 0xc0000084;
#define MSR_FS_BASE 0xc0000100       
#define MSR_GS_BASE 0xc0000101     
#define MSR_SHADOW_GS_BASE 0xc0000102 





extern"C"
{
	void VMMEntry();
	NTSTATUS __VMXCS(int i);
	void __invd();
	void asmsgdt(PVOID);
	USHORT __Es();
	USHORT __Cs();
	USHORT __Ss();
	USHORT __Fs();
	USHORT __Gs();
	USHORT __Ldtr();
	USHORT __Tr();
	USHORT __Ds();
}
extern VOID(__stdcall *KeSetAffinityThread)(IN PKTHREAD, IN KAFFINITY);

void getSegment(PSegment pSegment);


# define VMX_CONTROL_REG_ACCESS_TYPE_MOV_TO_CR   0
# define VMX_CONTROL_REG_ACCESS_TYPE_MOV_FROM_CR 1
# define VMX_CONTROL_REG_ACCESS_TYPE_CLTS        2
# define VMX_CONTROL_REG_ACCESS_TYPE_LMSW        3





NTSTATUS Stack(int i);




#define KGDT64_NULL (0 * 16)    // NULL descriptor
#define KGDT64_R0_CODE (1 * 16) // kernel mode 64-bit code
#define KGDT64_R0_DATA (1 * 16) + 8     // kernel mode 64-bit data (stack)
#define KGDT64_R3_CMCODE (2 * 16)       // user mode 32-bit code
#define KGDT64_R3_DATA (2 * 16) + 8     // user mode 32-bit data
#define KGDT64_R3_CODE (3 * 16) // user mode 64-bit code
#define KGDT64_SYS_TSS (4 * 16) // kernel mode system task state
#define KGDT64_R3_CMTEB (5 * 16)        // user mode 32-bit TEB
#define KGDT64_R0_CMCODE (6 * 16)       // kernel mode 32-bit code










ULONG64  MsrRead(ULONG32 reg)
{
	return __readmsr(reg);

}
#pragma pack(1)
typedef struct _SEGMENT_DESCRIPTOR
{
	USHORT limit0;
	USHORT base0;
	UCHAR base1;
	UCHAR attr0;
	UCHAR limit1attr1;
	UCHAR base2;
} SEGMENT_DESCRIPTOR, *PSEGMENT_DESCRIPTOR;
#pragma pack()



#define raxRegister 0
#define rcxRegister 1
#define rdxRegister 2
#define rbxRegister 3
#define rspRegister 4
#define rbpRegister 5 
#define rsiRegister 6
#define rdiRegister 7 
#define r8Register  8
#define r9Register  9
#define r10Register 10
#define r11Register 11
#define r12Register 12
#define r13Register 13
#define r14Register 14 
#define r15Register 15

#define MovToCr 0
#define MovFromCr 1
#define CLTSoperator 2
#define LMSWoperator 3